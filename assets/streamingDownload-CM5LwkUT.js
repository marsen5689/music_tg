class w{abortController;constructor(){this.abortController=new AbortController}async startStreaming(i,e,s,a){if(!("serviceWorker"in navigator)||!navigator.serviceWorker.controller)throw new Error("Service Worker not active. Cannot stream.");const r=Math.random().toString(36).substring(7),{readable:t,writable:n}=new TransformStream,l={type:"REGISTER_STREAM",id:r,stream:t,mimeType:s,size:e.media?.fileSize||0};return navigator.serviceWorker.controller.postMessage(l,[t]),this.downloadToStream(i,e,n,a),`${"./".endsWith("/")?"./":".//"}stream/${r}`}async downloadToStream(i,e,s,a){const r=s.getWriter(),t=e.media,n=t.fileSize||0;let l=0;try{console.log("Starting stream download...");for await(const o of i.downloadAsIterable(t)){if(this.abortController.signal.aborted)throw new Error("Aborted");await r.write(o),l+=o.length,a&&n>0&&a(l/n*100)}console.log("Stream download complete"),await r.close()}catch(o){console.error("Stream download error:",o);try{await r.abort(o)}catch{}}}cleanup(){this.abortController.abort()}}export{w as StreamingAudioDownloader};
