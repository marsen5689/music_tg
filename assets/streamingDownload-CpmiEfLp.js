class w{abortController;constructor(){this.abortController=new AbortController}async startStreaming(l,e,s,a){if(!("serviceWorker"in navigator)||!navigator.serviceWorker.controller)throw new Error("Service Worker not active. Cannot stream.");const r=Math.random().toString(36).substring(7),{readable:o,writable:n}=new TransformStream,i={type:"REGISTER_STREAM",id:r,stream:o,mimeType:s,size:e.media?.fileSize||0};return navigator.serviceWorker.controller.postMessage(i,[o]),this.downloadToStream(l,e,n,a),`/stream/${r}`}async downloadToStream(l,e,s,a){const r=s.getWriter(),o=e.media,n=o.fileSize||0;let i=0;try{console.log("Starting stream download...");for await(const t of l.downloadAsIterable(o)){if(this.abortController.signal.aborted)throw new Error("Aborted");await r.write(t),i+=t.length,a&&n>0&&a(i/n*100)}console.log("Stream download complete"),await r.close()}catch(t){console.error("Stream download error:",t);try{await r.abort(t)}catch{}}}cleanup(){this.abortController.abort()}}export{w as StreamingAudioDownloader};
