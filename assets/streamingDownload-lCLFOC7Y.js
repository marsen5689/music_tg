import{t as a,B as u}from"./index-DnFTVsG_.js";class h{mediaSource;sourceBuffer=null;chunks=[];isAppending=!1;downloadComplete=!1;isAborted=!1;constructor(){this.mediaSource=new MediaSource}async startStreaming(i,r,t,d){if(!MediaSource.isTypeSupported(t)&&!["audio/mpeg",'audio/mp4; codecs="mp4a.40.2"','audio/webm; codecs="opus"'].find(n=>n.startsWith(t.split("/")[0])&&MediaSource.isTypeSupported(n))&&t!=="audio/mp4"&&t!=="audio/webm")throw console.warn(`MediaSource usually does not support ${t}, triggering fallback.`),new Error(`MIME type ${t} not supported by MediaSource`);const c=URL.createObjectURL(this.mediaSource),s=async()=>{try{if(this.mediaSource.readyState!=="open")return;console.log("MediaSource open. Using mimeType:",t);let o=t;MediaSource.isTypeSupported(o)||(MediaSource.isTypeSupported('audio/mp4; codecs="mp4a.40.2"')?o='audio/mp4; codecs="mp4a.40.2"':MediaSource.isTypeSupported("audio/mpeg")&&(o="audio/mpeg"));try{if(r.media instanceof a.Api.MessageMediaDocument&&r.media.document instanceof a.Api.Document){for(const e of r.media.document.attributes)if(e instanceof a.Api.DocumentAttributeAudio&&e.duration){this.mediaSource.duration=e.duration;break}}}catch(e){console.warn("Failed to set MediaSource duration:",e)}try{this.sourceBuffer=this.mediaSource.addSourceBuffer(o)}catch(e){throw console.error("Failed to add SourceBuffer with type:",o,e),e}this.sourceBuffer.addEventListener("updateend",()=>{this.isAppending=!1,this.processQueue()}),this.sourceBuffer.addEventListener("error",e=>{console.error("SourceBuffer error:",e)}),await this.downloadInChunks(i,r,d)}catch(o){console.error("Streaming error in handleSourceOpen:",o);try{this.mediaSource.readyState==="open"&&this.mediaSource.endOfStream("decode")}catch{}}};return this.mediaSource.addEventListener("sourceopen",s),this.mediaSource.addEventListener("sourceclose",()=>{console.log("MediaSource closed")}),c}async downloadInChunks(i,r,t){if(!r.media||!(r.media instanceof a.Api.MessageMediaDocument))throw new Error("Invalid media");const d=r.media.document;if(!(d instanceof a.Api.Document))throw new Error("Invalid document");const c=Number(d.size);console.log("Starting streaming download, file size:",c);let s=0;try{for await(const e of i.iterDownload({file:r.media,chunkSize:131072,requestSize:131072})){if(this.isAborted)throw new Error("DOWNLOAD_ABORTED");if(!e||e.length===0)continue;let n;e instanceof u?n=new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e instanceof Uint8Array?n=e:n=new Uint8Array(e),this.chunks.push(n),this.processQueue(),s+=n.length,t&&t(s/c*100)}this.isAborted||(console.log("Download complete, total size:",s),this.downloadComplete=!0,this.finalizeStream())}catch(o){if(o instanceof Error&&o.message==="DOWNLOAD_ABORTED")console.log("Download aborted");else throw console.error("Streaming download error:",o),o}}processQueue(){if(this.isAppending||!this.sourceBuffer||this.chunks.length===0||this.isAborted||this.sourceBuffer.updating)return;const i=this.chunks.shift();if(i)try{this.isAppending=!0,this.sourceBuffer.appendBuffer(i)}catch(r){console.error("Error appending buffer:",r),this.isAppending=!1}}finalizeStream(){if(this.downloadComplete&&this.chunks.length===0&&!this.isAppending){if(this.mediaSource.readyState==="open"&&!this.isAborted)try{this.mediaSource.endOfStream(),console.log("Stream finalized")}catch(i){console.error("Error finalizing stream:",i)}}else this.isAborted||setTimeout(()=>this.finalizeStream(),100)}cleanup(){if(this.isAborted=!0,this.mediaSource.readyState==="open")try{this.mediaSource.endOfStream()}catch{}}}export{h as StreamingAudioDownloader};
