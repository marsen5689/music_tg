class u{mediaSource;sourceBuffer=null;chunks=[];isAppending=!1;downloadComplete=!1;isAborted=!1;constructor(){this.mediaSource=new MediaSource}async startStreaming(r,i,t,n){if(!MediaSource.isTypeSupported(t)&&!["audio/mpeg",'audio/mp4; codecs="mp4a.40.2"','audio/webm; codecs="opus"'].find(d=>d.startsWith(t.split("/")[0])&&MediaSource.isTypeSupported(d))&&t!=="audio/mp4"&&t!=="audio/webm")throw console.warn(`MediaSource usually does not support ${t}, triggering fallback.`),new Error(`MIME type ${t} not supported by MediaSource`);const s=URL.createObjectURL(this.mediaSource),a=async()=>{try{if(this.mediaSource.readyState!=="open")return;console.log("MediaSource open. Using mimeType:",t);let e=t;MediaSource.isTypeSupported(e)||(MediaSource.isTypeSupported('audio/mp4; codecs="mp4a.40.2"')?e='audio/mp4; codecs="mp4a.40.2"':MediaSource.isTypeSupported("audio/mpeg")&&(e="audio/mpeg"));try{if(i.media?.type==="document"&&i.media.type==="audio"){const o=i.media;o.duration&&(this.mediaSource.duration=o.duration)}}catch(o){console.warn("Failed to set MediaSource duration:",o)}try{this.sourceBuffer=this.mediaSource.addSourceBuffer(e)}catch(o){throw console.error("Failed to add SourceBuffer with type:",e,o),o}this.sourceBuffer.addEventListener("updateend",()=>{this.isAppending=!1,this.processQueue()}),this.sourceBuffer.addEventListener("error",o=>{console.error("SourceBuffer error:",o)}),await this.downloadInChunks(r,i,n)}catch(e){console.error("Streaming error in handleSourceOpen:",e);try{this.mediaSource.readyState==="open"&&this.mediaSource.endOfStream("decode")}catch{}}};return this.mediaSource.addEventListener("sourceopen",a),this.mediaSource.addEventListener("sourceclose",()=>{console.log("MediaSource closed")}),s}async downloadInChunks(r,i,t){if(!i.media||i.media.type!=="document")throw new Error("Invalid media");const n=i.media,s=n.fileSize||0;console.log("Starting streaming download, file size:",s);let a=0;try{for await(const e of r.downloadAsIterable(n)){if(this.isAborted)throw new Error("DOWNLOAD_ABORTED");if(!e||e.length===0)continue;const o=e instanceof Uint8Array?e:new Uint8Array(e);this.chunks.push(o),this.processQueue(),a+=o.length,t&&s>0&&t(a/s*100)}this.isAborted||(console.log("Download complete, total size:",a),this.downloadComplete=!0,this.finalizeStream())}catch(e){if(e instanceof Error&&e.message==="DOWNLOAD_ABORTED")console.log("Download aborted");else throw console.error("Streaming download error:",e),e}}processQueue(){if(this.isAppending||!this.sourceBuffer||this.chunks.length===0||this.isAborted||this.sourceBuffer.updating)return;const r=this.chunks.shift();if(r)try{this.isAppending=!0,this.sourceBuffer.appendBuffer(r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength))}catch(i){console.error("Error appending buffer:",i),this.isAppending=!1}}finalizeStream(){if(this.downloadComplete&&this.chunks.length===0&&!this.isAppending){if(this.mediaSource.readyState==="open"&&!this.isAborted)try{this.mediaSource.endOfStream(),console.log("Stream finalized")}catch(r){console.error("Error finalizing stream:",r)}}else this.isAborted||setTimeout(()=>this.finalizeStream(),100)}cleanup(){if(this.isAborted=!0,this.mediaSource.readyState==="open")try{this.mediaSource.endOfStream()}catch{}}}export{u as StreamingAudioDownloader};
